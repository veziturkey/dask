<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اتحاد نقابات العمال - لوحة تحكم المشرفين - تحديث مباشر</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ✅ Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <!-- ✅ مكتبة html2canvas لتحويل HTML إلى صورة -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary: #2c5282;
            --primary-dark: #1a3a5f;
            --secondary: #e53e3e;
            --accent: #ffd700;
            --success: #38a169;
            --warning: #d69e2e;
            --info: #4299e1;
            --light: #f7fafc;
            --dark: #2d3748;
            --gray: #718096;
            --gray-light: #e2e8f0;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 10px 25px rgba(0, 0, 0, 0.15);
            --radius: 12px;
            --border-radius-large: 16px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            height: 100%;
            width: 100%;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: var(--dark);
            line-height: 1.6;
            font-weight: 400;
            overflow-x: hidden;
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }
        
        .container {
            width: 100%;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
            animation: fadeIn 0.6s ease-out;
            display: flex;
            flex-direction: column;
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.98); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--secondary) 0%, var(--accent) 100%);
        }
        
        .header::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 30% 20%, rgba(255, 215, 0, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            gap: 15px;
        }
        
        .logo {
            width: 70px;
            height: 70px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid var(--accent);
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1;
            transition: var(--transition);
        }
        
        .logo:hover {
            transform: rotate(5deg) scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .logo img {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }
        
        .titles {
            text-align: center;
        }
        
        .main-title {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 6px;
            color: white;
            text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.3);
            letter-spacing: -0.5px;
            position: relative;
            display: inline-block;
            line-height: 1.3;
        }
        
        .main-title::after {
            content: '';
            position: absolute;
            bottom: -4px;
            right: 0;
            width: 100%;
            height: 2px;
            background: var(--accent);
            border-radius: 2px;
        }
        
        .sub-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: rgba(255, 255, 255, 0.95);
        }
        
        .dashboard-title {
            font-size: 20px;
            font-weight: 700;
            margin-top: 15px;
            color: var(--accent);
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.25);
            border-radius: 10px;
            display: inline-block;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .realtime-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(56, 161, 105, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            margin-top: 10px;
            font-size: 14px;
            font-weight: 600;
            animation: pulse 2s infinite;
        }
        
        .realtime-indicator.off {
            background: rgba(113, 128, 150, 0.2);
            animation: none;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(56, 161, 105, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(56, 161, 105, 0); }
            100% { box-shadow: 0 0 0 0 rgba(56, 161, 105, 0); }
        }
        
        .dashboard-container {
            padding: 25px 20px;
            flex-grow: 1;
            overflow-y: auto;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 25px 20px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border-top: 4px solid var(--primary);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
            pointer-events: none;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }
        
        .stat-card.new {
            border-top-color: var(--success);
        }
        
        .stat-card.completed {
            border-top-color: var(--primary);
        }
        
        .stat-card.all {
            border-top-color: var(--accent);
        }
        
        .stat-card.renew {
            border-top-color: #805ad5;
        }
        
        .stat-card.today {
            border-top-color: var(--info);
        }
        
        .stat-icon {
            font-size: 40px;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .stat-card.new .stat-icon {
            color: var(--success);
        }
        
        .stat-card.completed .stat-icon {
            color: var(--primary);
        }
        
        .stat-card.all .stat-icon {
            color: var(--accent);
        }
        
        .stat-card.renew .stat-icon {
            color: #805ad5;
        }
        
        .stat-card.today .stat-icon {
            color: var(--info);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 8px;
            color: var(--primary-dark);
        }
        
        .stat-label {
            font-size: 16px;
            color: var(--gray);
            font-weight: 600;
        }
        
        .stat-update {
            font-size: 12px;
            color: var(--gray);
            margin-top: 8px;
            opacity: 0.8;
        }
        
        .controls {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .search-container {
            flex-grow: 1;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 14px 15px 14px 45px;
            border: 2px solid var(--gray-light);
            border-radius: 10px;
            font-size: 15px;
            transition: var(--transition);
            background: white;
            color: var(--dark);
            font-weight: 500;
            font-family: 'Cairo', sans-serif;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(44, 82, 130, 0.2);
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            font-size: 16px;
        }
        
        .filter-select {
            padding: 14px 20px;
            border: 2px solid var(--gray-light);
            border-radius: 10px;
            font-size: 15px;
            background: white;
            color: var(--dark);
            cursor: pointer;
            min-width: 180px;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 14px 25px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 10px rgba(44, 82, 130, 0.3);
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(44, 82, 130, 0.4);
        }
        
        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .live-update-toggle {
            background: linear-gradient(135deg, var(--success) 0%, #2f855a 100%);
            color: white;
            border: none;
            padding: 14px 25px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 10px rgba(56, 161, 105, 0.3);
        }
        
        .live-update-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(56, 161, 105, 0.4);
        }
        
        .live-update-toggle.disabled {
            background: linear-gradient(135deg, var(--gray) 0%, #4a5568 100%);
        }
        
        .applications-table-container {
            background: white;
            border-radius: var(--radius);
            padding: 0;
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        
        .table-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        thead {
            background: var(--light);
            border-bottom: 2px solid var(--gray-light);
        }
        
        th {
            padding: 16px 15px;
            text-align: right;
            font-weight: 700;
            color: var(--primary-dark);
            font-size: 15px;
        }
        
        td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid var(--gray-light);
            font-size: 14px;
            color: var(--dark);
        }
        
        tr:hover {
            background: rgba(44, 82, 130, 0.05);
        }
        
        tr.new-row {
            animation: highlightRow 2s ease-out;
            background: linear-gradient(135deg, rgba(56, 161, 105, 0.15) 0%, rgba(56, 161, 105, 0.08) 100%) !important;
        }
        
        tr.new-row.unread {
            background: linear-gradient(135deg, rgba(56, 161, 105, 0.25) 0%, rgba(56, 161, 105, 0.15) 100%) !important;
            border-left: 4px solid var(--success);
        }
        
        @keyframes highlightRow {
            0% { background: rgba(56, 161, 105, 0.3); }
            100% { background: rgba(56, 161, 105, 0.15); }
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            transition: var(--transition);
        }
        
        .status-pending {
            background: rgba(214, 158, 46, 0.1);
            color: var(--warning);
            border: 1px solid rgba(214, 158, 46, 0.3);
        }
        
        .status-pending:hover {
            background: rgba(214, 158, 46, 0.2);
            transform: scale(1.05);
        }
        
        .status-completed {
            background: rgba(56, 161, 105, 0.1);
            color: var(--success);
            border: 1px solid rgba(56, 161, 105, 0.3);
        }
        
        .status-completed:hover {
            background: rgba(56, 161, 105, 0.2);
            transform: scale(1.05);
        }
        
        .status-new {
            background: rgba(66, 153, 225, 0.1);
            color: var(--primary);
            border: 1px solid rgba(66, 153, 225, 0.3);
        }
        
        .status-renew {
            background: rgba(159, 122, 234, 0.1);
            color: #805ad5;
            border: 1px solid rgba(159, 122, 234, 0.3);
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 70px;
            justify-content: center;
        }
        
        .btn-view {
            background: rgba(66, 153, 225, 0.1);
            color: var(--primary);
            border: 1px solid rgba(66, 153, 225, 0.3);
        }
        
        .btn-view:hover {
            background: rgba(66, 153, 225, 0.2);
            transform: translateY(-2px);
        }
        
        .btn-print {
            background: rgba(45, 55, 72, 0.1);
            color: var(--dark);
            border: 1px solid rgba(45, 55, 72, 0.3);
        }
        
        .btn-print:hover {
            background: rgba(45, 55, 72, 0.2);
            transform: translateY(-2px);
        }
        
        .btn-delete {
            background: rgba(229, 62, 62, 0.1);
            color: var(--secondary);
            border: 1px solid rgba(229, 62, 62, 0.3);
        }
        
        .btn-delete:hover {
            background: rgba(229, 62, 62, 0.2);
            transform: translateY(-2px);
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            padding: 20px;
        }
        
        .page-btn {
            padding: 10px 15px;
            border: 1px solid var(--gray-light);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }
        
        .page-btn:hover {
            background: var(--light);
            border-color: var(--primary);
        }
        
        .page-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .footer {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            padding: 15px 20px;
            text-align: center;
            color: white;
            font-size: 14px;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .footer::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent) 0%, var(--secondary) 100%);
        }
        
        .footer p {
            margin-bottom: 10px;
            opacity: 0.95;
            font-size: 13px;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            opacity: 0;
            animation: fadeInOverlay 0.3s forwards;
        }
        
        @keyframes fadeInOverlay {
            to { opacity: 1; }
        }
        
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: white;
            border-radius: var(--border-radius-large);
            padding: 25px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            max-width: 95%;
            width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            display: none;
            opacity: 0;
            animation: modalShow 0.3s forwards;
        }
        
        @keyframes modalShow {
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gray-light);
        }
        
        .modal-title {
            font-size: 22px;
            color: var(--primary-dark);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .close-modal:hover {
            background: var(--gray-light);
            color: var(--secondary);
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .view-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .view-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
        
        .photo-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .view-photo-container {
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            padding: 15px;
            background: var(--light);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 220px;
            width: 100%;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .view-photo-container:hover {
            border-color: var(--primary);
            box-shadow: 0 5px 15px rgba(44, 82, 130, 0.1);
        }
        
        .view-photo {
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
            object-fit: cover;
            margin-bottom: 10px;
            display: none;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .view-photo:hover {
            transform: scale(1.05);
        }
        
        .view-photo-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--gray);
            font-size: 14px;
            padding: 20px;
            text-align: center;
        }
        
        .view-photo-placeholder i {
            font-size: 40px;
            margin-bottom: 8px;
            color: var(--primary);
        }
        
        .card-photos-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        
        @media (max-width: 768px) {
            .card-photos-container {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .card-photos-container {
                grid-template-columns: 1fr;
            }
        }
        
        .card-photo-box {
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            padding: 12px;
            background: white;
            text-align: center;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .card-photo-box:hover {
            border-color: var(--primary);
        }
        
        .card-photo-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 8px;
        }
        
        .card-photo-preview {
            max-width: 100%;
            max-height: 80px;
            border-radius: 4px;
            object-fit: cover;
            display: none;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .card-photo-preview:hover {
            transform: scale(1.1);
        }
        
        .card-photo-placeholder {
            font-size: 11px;
            color: var(--gray);
        }
        
        .view-details {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .view-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-light);
            min-height: 40px;
        }
        
        .view-label {
            font-weight: 700;
            color: var(--primary-dark);
            font-size: 15px;
            min-width: 150px;
            margin-left: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .view-label i {
            color: var(--primary);
            font-size: 14px;
        }
        
        .view-value {
            color: var(--dark);
            font-size: 15px;
            text-align: right;
            flex-grow: 1;
            word-break: break-word;
            font-weight: 500;
        }
        
        .view-value.editable {
            background: rgba(44, 82, 130, 0.05);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px dashed var(--primary);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .view-value.editable:hover {
            background: rgba(44, 82, 130, 0.1);
            border: 1px solid var(--primary);
        }
        
        .edit-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid var(--primary);
            border-radius: 6px;
            font-size: 15px;
            background: white;
            color: var(--dark);
            font-family: 'Cairo', sans-serif;
            transition: var(--transition);
        }
        
        .edit-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(44, 82, 130, 0.2);
        }
        
        .edit-buttons {
            display: flex;
            gap: 8px;
            margin-top: 5px;
        }
        
        .edit-btn {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-weight: 600;
        }
        
        .edit-btn.save {
            background: var(--success);
            color: white;
        }
        
        .edit-btn.cancel {
            background: var(--gray);
            color: white;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--gray-light);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(44, 82, 130, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--gray) 0%, #4a5568 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            min-width: 100px;
            justify-content: center;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(113, 128, 150, 0.3);
        }
        
        .btn-print-action {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
            justify-content: center;
        }
        
        .btn-print-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(45, 55, 72, 0.3);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }
        
        .loading i {
            font-size: 40px;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }
        
        .no-data i {
            font-size: 50px;
            margin-bottom: 15px;
            color: var(--gray-light);
        }
        
        /* إشعارات */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            animation: slideDown 0.3s ease-out;
        }
        
        .notification.success {
            background: linear-gradient(135deg, var(--success) 0%, #2f855a 100%);
            color: white;
        }
        
        .notification.error {
            background: linear-gradient(135deg, var(--secondary) 0%, #c53030 100%);
            color: white;
        }
        
        .notification.info {
            background: linear-gradient(135deg, var(--info) 0%, #3182ce 100%);
            color: white;
        }
        
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        /* Modal لعرض الصورة بشكل كامل */
        .image-viewer-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(0, 0, 0, 0.95);
            border-radius: var(--border-radius-large);
            padding: 20px;
            z-index: 2002;
            max-width: 95%;
            max-height: 95vh;
            display: none;
            opacity: 0;
            animation: imageViewerShow 0.3s forwards;
            overflow: hidden;
        }
        
        @keyframes imageViewerShow {
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        .image-viewer-content {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        
        .image-viewer-img {
            max-width: 90vw;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .image-viewer-close {
            position: absolute;
            top: -15px;
            left: -15px;
            background: var(--secondary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2003;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .image-viewer-close:hover {
            background: #c53030;
            transform: scale(1.1);
        }
        
        .image-viewer-title {
            color: white;
            margin-top: 15px;
            font-size: 16px;
            text-align: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 6px;
        }
        
        /* ========== ✅ وصل الانتساب الرسمي من الكود الأول ========== */
        .official-receipt {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 800px;
            min-height: 1000px;
            background: white;
            padding: 20px;
            text-align: right;
            z-index: -1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            box-sizing: border-box;
            border: none;
            overflow: hidden;
            font-size: 14px;
        }
        
        .official-receipt.visible {
            transform: translate(-50%, -50%) scale(0.9);
            opacity: 1;
            visibility: visible;
            z-index: 2000;
        }
        
        .official-content {
            padding: 30px;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
        }
        
        .official-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 3px solid #000;
        }
        
        .official-logo {
            width: 100px;
            height: 100px;
            margin: 0 auto 15px;
        }
        
        .official-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .official-main-title {
            font-size: 24px;
            font-weight: bold;
            color: #000;
            margin-bottom: 8px;
        }
        
        .official-sub-title {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .official-body {
            margin-bottom: 30px;
        }
        
        .photo-and-details {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
        }
        
        .official-photo-container {
            width: 180px;
            height: 220px;
            border: 2px solid #ccc;
            position: relative;
            background: #f9f9f9;
            flex-shrink: 0;
            margin-left: 20px;
            margin-top: 0;
        }
        
        .official-photo-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .official-photo-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 12px;
        }
        
        .official-photo-placeholder i {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .official-details {
            flex-grow: 1;
            margin-right: 0;
        }
        
        .official-info-row {
            display: flex;
            margin-bottom: 10px;
            padding: 6px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .official-info-label {
            width: 160px;
            font-weight: bold;
            color: #000;
            font-size: 14px;
        }
        
        .official-info-value {
            flex-grow: 1;
            color: #333;
            font-size: 14px;
            font-weight: bold;
        }
        
        .empty-field {
            color: #999;
        }
        
        .declaration-section {
            border: 2px solid #000;
            padding: 20px;
            margin: 25px 0;
            background: #f8f8f8;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .declaration-title {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
            color: #2c5282;
        }
        
        .declaration-text {
            text-align: justify;
            margin-bottom: 10px;
            font-size: 13px;
            font-weight: bold;
        }
        
        .signatures-section {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
        }
        
        .official-signature-box {
            width: 250px;
            text-align: center;
        }
        
        .official-signature-line {
            height: 2px;
            background: #000;
            margin: 40px 0 10px;
        }
        
        .official-signature-label {
            font-size: 14px;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .document-date {
            text-align: center;
            margin-top: 30px;
            font-size: 14px;
            font-weight: bold;
        }
        
        @media print {
            .official-receipt {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                transform: none !important;
                width: 100% !important;
                height: auto !important;
                margin: 0 !important;
                padding: 10mm !important;
                box-shadow: none !important;
                border: none !important;
            }
            
            .official-content {
                padding: 0 !important;
            }
            
            .official-header {
                margin-bottom: 20px !important;
            }
            
            .official-main-title {
                font-size: 20pt !important;
            }
            
            .official-sub-title {
                font-size: 16pt !important;
            }
            
            .official-info-row {
                font-size: 11pt !important;
            }
            
            .declaration-text {
                font-size: 10pt !important;
            }
        }
        
        @media (max-width: 850px) {
            .official-receipt {
                width: 95% !important;
                min-height: auto !important;
                padding: 15px !important;
            }
            
            .official-content {
                padding: 20px !important;
            }
            
            .photo-and-details {
                flex-direction: column !important;
            }
            
            .official-photo-container {
                width: 150px !important;
                height: 180px !important;
                margin: 0 auto 20px !important;
            }
            
            .official-details {
                margin-right: 0 !important;
            }
            
            .official-info-label {
                width: 140px !important;
            }
            
            .signatures-section {
                flex-direction: column !important;
                gap: 30px !important;
            }
            
            .official-signature-box {
                width: 100% !important;
            }
        }
        
        @media (max-width: 480px) {
            .official-receipt {
                transform: translate(-50%, -50%) scale(0.8) !important;
            }
            
            .official-main-title {
                font-size: 20px !important;
            }
            
            .official-sub-title {
                font-size: 16px !important;
            }
            
            .official-info-row {
                flex-direction: column !important;
                margin-bottom: 8px !important;
            }
            
            .official-info-label {
                width: 100% !important;
                margin-bottom: 2px !important;
            }
        }
        
        /* Media Queries */
        @media (max-width: 768px) {
            .stats-cards {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-select {
                width: 100%;
            }
            
            .modal {
                width: 95%;
                padding: 20px;
            }
            
            .view-layout {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .view-photo-container {
                min-height: 200px;
                width: 100%;
                max-width: 180px;
                margin: 0 auto;
            }
            
            .table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 5px;
            }
            
            .btn {
                width: 100%;
            }
            
            .modal-footer {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .modal-footer button {
                flex: 1;
                min-width: 120px;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 20px 15px;
            }
            
            .logo-container {
                flex-direction: column;
                text-align: center;
            }
            
            .main-title {
                font-size: 20px;
            }
            
            .sub-title {
                font-size: 16px;
            }
            
            .dashboard-container {
                padding: 15px;
            }
            
            .stat-card {
                padding: 20px 15px;
            }
            
            .stat-value {
                font-size: 28px;
            }
            
            .modal-footer {
                flex-direction: column;
            }
            
            .modal-footer button {
                width: 100%;
            }
        }
        
        /* تنسيقات اختيار النقابة */
        .union-selection-container {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%);
            border-radius: 8px;
            border: 2px solid var(--primary);
        }
        
        .union-selection-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .union-selection-title i {
            color: var(--primary);
        }
        
        .union-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 15px;
            background: white;
            color: var(--dark);
            font-weight: 500;
            font-family: 'Cairo', sans-serif;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .union-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(44, 82, 130, 0.2);
        }
        
        .selected-union-display {
            background: white;
            padding: 12px 15px;
            border-radius: 8px;
            border: 2px solid var(--primary);
            font-weight: 600;
            color: var(--primary-dark);
            display: none;
            margin-top: 10px;
            text-align: center;
        }
        
        .selected-union-display.visible {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo-container">
                <div class="logo">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQNX9aZzQhhFn-2gj2MIS8D4mn-5iizM4hgXQ&s" alt="شعار اتحاد نقابات العمال">
                </div>
                <div class="titles">
                    <h1 class="main-title">اتحاد نقابات العمال في العراق</h1>
                    <h2 class="sub-title">اتحاد نقابات عمال ذي قار</h2>
                    <div class="dashboard-title">
                        <i class="fas fa-tachometer-alt"></i> لوحة تحكم المشرفين
                    </div>
                    <div class="realtime-indicator" id="realtimeIndicator">
                        <i class="fas fa-broadcast-tower"></i>
                        <span>التحديث المباشر مفعل</span>
                    </div>
                </div>
            </div>
        </header>
        
        <main class="dashboard-container">
            <div class="stats-cards">
                <div class="stat-card new">
                    <div class="stat-icon">
                        <i class="fas fa-id-card"></i>
                    </div>
                    <div class="stat-value" id="newCount">0</div>
                    <div class="stat-label">طلبات جديدة</div>
                    <div class="stat-update" id="newUpdateTime">--</div>
                </div>
                
                <div class="stat-card renew">
                    <div class="stat-icon">
                        <i class="fas fa-sync-alt"></i>
                    </div>
                    <div class="stat-value" id="renewCount">0</div>
                    <div class="stat-label">طلبات تجديد</div>
                    <div class="stat-update" id="renewUpdateTime">--</div>
                </div>
                
                <div class="stat-card completed">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-value" id="completedCount">0</div>
                    <div class="stat-label">طلبات مكتملة</div>
                    <div class="stat-update" id="completedUpdateTime">--</div>
                </div>
                
                <div class="stat-card all">
                    <div class="stat-icon">
                        <i class="fas fa-list-alt"></i>
                    </div>
                    <div class="stat-value" id="allCount">0</div>
                    <div class="stat-label">إجمالي الطلبات</div>
                    <div class="stat-update" id="allUpdateTime">--</div>
                </div>
                
                <div class="stat-card today">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                    <div class="stat-value" id="todayCount">0</div>
                    <div class="stat-label">طلبات اليوم</div>
                    <div class="stat-update" id="todayUpdateTime">--</div>
                </div>
            </div>
            
            <div class="controls">
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="searchInput" placeholder="ابحث بالاسم أو رقم الهاتف أو رقم الطلب...">
                </div>
                
                <select class="filter-select" id="typeFilter">
                    <option value="all">جميع الأنواع</option>
                    <option value="new">طلبات جديدة</option>
                    <option value="renew">طلبات تجديد</option>
                </select>
                
                <select class="filter-select" id="statusFilter">
                    <option value="all">جميع الحالات</option>
                    <option value="pending">قيد المعالجة</option>
                    <option value="completed">مكتملة</option>
                </select>
                
                <button class="refresh-btn" id="refreshBtn">
                    <i class="fas fa-redo"></i> تحديث
                </button>
                
                <button class="live-update-toggle" id="liveUpdateToggle">
                    <i class="fas fa-broadcast-tower"></i> تحديث مباشر: مفعل
                </button>
            </div>
            
            <div class="applications-table-container">
                <div class="table-header">
                    <div>
                        <i class="fas fa-list-alt"></i> طلبات الانتساب
                        <span id="totalApplicationsCount" style="font-size: 14px; margin-right: 10px; opacity: 0.9;">(0)</span>
                    </div>
                    <div id="lastUpdateTime" style="font-size: 14px; opacity: 0.9;">
                        آخر تحديث: --
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="applicationsTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>رقم الطلب</th>
                                <th>الاسم الرباعي</th>
                                <th>رقم الهاتف</th>
                                <th>نوع الطلب</th>
                                <th>تاريخ الإرسال</th>
                                <th>الحالة</th>
                                <th>النقابة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="applicationsTableBody">
                            <!-- سيتم تعبئة البيانات هنا -->
                        </tbody>
                    </table>
                </div>
                
                <div class="loading" id="tableLoading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>جاري تحميل البيانات...</p>
                </div>
                
                <div class="no-data" id="noDataMessage" style="display: none;">
                    <i class="fas fa-database"></i>
                    <p>لا توجد بيانات لعرضها</p>
                </div>
                
                <div class="pagination" id="pagination" style="display: none;">
                    <!-- سيتم إنشاء أزرار الصفحات هنا -->
                </div>
            </div>
        </main>
        
        <footer class="footer">
            <p>© 2026 اتحاد نقابات العمال في العراق - اتحاد نقابات عمال ذي قار. جميع الحقوق محفوظة.</p>
            <p>لوحة تحكم المشرفين - الإصدار 2.0 - تحديث مباشر</p>
        </footer>
    </div>
    
    <!-- Modal لعرض البيانات -->
    <div class="modal-overlay" id="modalOverlay"></div>
    
    <div class="modal" id="viewModal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-eye"></i> عرض تفاصيل الطلب</h3>
            <button class="close-modal" id="closeViewModal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="view-layout">
                <div class="photo-section">
                    <div class="view-photo-container" onclick="showFullImage('personalPhoto')">
                        <img class="view-photo" id="viewPersonalPhoto" alt="الصورة الشخصية">
                        <div class="view-photo-placeholder" id="viewPhotoPlaceholder">
                            <i class="fas fa-user-circle"></i>
                            <p>لا توجد صورة شخصية</p>
                            <small>انقر لعرض الصورة بشكل كامل</small>
                        </div>
                    </div>
                    
                    <div class="card-photos-container">
                        <div class="card-photo-box" onclick="showFullImage('idFront')">
                            <div class="card-photo-label">الوجه الأمامي للهوية</div>
                            <img class="card-photo-preview" id="viewIdFront" alt="الوجه الأمامي للهوية">
                            <div class="card-photo-placeholder" id="idFrontPlaceholder">
                                لا توجد صورة<br>
                                <small>انقر لعرض الصورة</small>
                            </div>
                        </div>
                        <div class="card-photo-box" onclick="showFullImage('idBack')">
                            <div class="card-photo-label">الوجه الخلفي للهوية</div>
                            <img class="card-photo-preview" id="viewIdBack" alt="الوجه الخلفي للهوية">
                            <div class="card-photo-placeholder" id="idBackPlaceholder">
                                لا توجد صورة<br>
                                <small>انقر لعرض الصورة</small>
                            </div>
                        </div>
                        <!-- ✅ إضافة صندوق لعرض صورة الهوية القديمة -->
                        <div class="card-photo-box" onclick="showFullImage('oldId')">
                            <div class="card-photo-label">الهوية القديمة</div>
                            <img class="card-photo-preview" id="viewOldId" alt="الهوية القديمة">
                            <div class="card-photo-placeholder" id="oldIdPlaceholder">
                                لا توجد صورة<br>
                                <small>انقر لعرض الصورة</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="view-details">
                    <div class="view-row">
                        <span class="view-label"><i class="fas fa-hashtag"></i> رقم الطلب:</span>
                        <span class="view-value" id="viewReceiptId">--</span>
                    </div>
                    <div class="view-row">
                        <span class="view-label"><i class="fas fa-user"></i> الاسم الرباعي:</span>
                        <span class="view-value editable" id="viewFullName" onclick="editField('full_name', this)">--</span>
                    </div>
                    <div class="view-row">
                        <span class="view-label"><i class="fas fa-heart"></i> اسم الزوج/ة:</span>
                        <span class="view-value editable" id="viewSpouseName" onclick="editField('spouse_name', this)">--</span>
                    </div>
                    <div class="view-row">
                        <span class="view-label"><i class="fas fa-map-marker-alt"></i> محل الولادة:</span>
                        <span class="view-value editable" id="viewBirthPlace" onclick="editField('birth_place', this)">--</span>
                    </div>
                    <div class="view-row">
                        <span class="view-label"><i class="fas fa-home"></i> مكان السكن الحالي:</span>
                        <span class="view-value editable" id="viewResidence" onclick="editField('residence', this)">--</span>
                    </div>
                    <div class="view-row">
                        <span class="view-label"><i class="fas fa-phone"></i> رقم الهاتف:</span>
                        <span class="view-value editable" id="viewPhoneNumber" onclick="editField('phone_number', this)">--</span>
                    </div>
                    <div class="view-row">
                        <span class="view-label"><i class="fas fa-id-card"></i> نوع الطلب:</span>
                        <span class="view-value" id="viewApplicationType">--</span>
                    </div>
                    <div class="view-row">
                        <span class="view-label"><i class="fas fa-calendar-check"></i> تاريخ المراجعة:</span>
                        <span class="view-value editable" id="viewReviewDate" onclick="editField('review_date', this)">--</span>
                    </div>
                    <div class="view-row">
                        <span class="view-label"><i class="fas fa-calendar-alt"></i> تاريخ الإصدار:</span>
                        <span class="view-value editable" id="viewIssueDate" onclick="editField('issue_date', this)">--</span>
                    </div>
                    <div class="view-row">
                        <span class="view-label"><i class="fas fa-info-circle"></i> الحالة:</span>
                        <span class="view-value" id="viewStatusText">--</span>
                    </div>
                    <div class="view-row">
                        <span class="view-label"><i class="fas fa-building"></i> النقابة:</span>
                        <span class="view-value editable" id="viewUnion" onclick="editField('union_name', this)">--</span>
                    </div>
                    <div class="view-row">
                        <span class="view-label"><i class="fas fa-clock"></i> تاريخ الإرسال:</span>
                        <span class="view-value" id="viewCreatedAt">--</span>
                    </div>
                </div>
            </div>
            
            <div class="union-selection-container">
                <div class="union-selection-title">
                    <i class="fas fa-building"></i> تحديث معلومات النقابة
                </div>
                <select class="union-select" id="viewUnionSelect">
                    <option value="">اختر النقابة...</option>
                    <option value="الميكانيك">الميكانيك</option>
                    <option value="الغزل والنسيج">الغزل والنسيج</option>
                    <option value="البناء">البناء</option>
                    <option value="الخدمات">الخدمات</option>
                    <option value="النقل">النقل</option>
                    <option value="المعادن">المعادن</option>
                    <option value="الزراعة">الزراعة</option>
                    <option value="الصحة">الصحة</option>
                    <option value="التعليم">التعليم</option>
                    <option value="المقاولات">المقاولات</option>
                </select>
                <div class="selected-union-display" id="selectedUnionDisplay">
                    النقابة المختارة: <span id="selectedUnionName"></span>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <label style="font-weight: bold; color: var(--primary-dark); margin-bottom: 8px; display: block; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-cogs"></i> تغيير حالة الطلب:
                </label>
                <select class="form-input" id="viewStatus" style="width: 100%; padding: 10px; border: 2px solid var(--gray-light); border-radius: 8px;">
                    <option value="pending">قيد المعالجة</option>
                    <option value="completed">مكتملة</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-print-action" id="printOfficialReceiptBtn" onclick="printOfficialReceiptFromViewModal()">
                <i class="fas fa-file-contract"></i> طباعة الوصل الرسمي
            </button>
            <button class="btn-secondary" id="closeViewBtn">إغلاق</button>
            <button class="btn-primary" id="saveChangesBtn">
                <i class="fas fa-save"></i> حفظ جميع التغييرات
            </button>
        </div>
    </div>

    <!-- Modal لعرض الصورة بشكل كامل -->
    <div class="image-viewer-modal" id="imageViewerModal">
        <div class="image-viewer-content">
            <button class="image-viewer-close" id="closeImageViewer">&times;</button>
            <img class="image-viewer-img" id="fullImageView" alt="صورة مكبرة">
            <div class="image-viewer-title" id="imageViewerTitle"></div>
        </div>
    </div>

    <!-- ========== ✅ وصل الانتساب الرسمي من الكود الأول ========== -->
    <div class="official-receipt" id="officialReceipt">
        <div class="official-content">
            <div class="official-header">
                <div class="official-logo">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQNX9aZzQhhFn-2gj2MIS8D4mn-5iizM4hgXQ&s" alt="شعار اتحاد نقابات العمال">
                </div>
                <h1 class="official-main-title">اتحاد نقابات العمال في العراق</h1>
                <h2 class="official-sub-title">اتحاد نقابات عمال ذي قار</h2>
            </div>
            
            <div class="official-body">
                <div class="photo-and-details">
                    <div class="official-details">
                        <div class="official-info-row">
                            <div class="official-info-label">الاسم الرباعي:</div>
                            <div class="official-info-value" id="officialFullName"></div>
                        </div>
                        
                        <div class="official-info-row">
                            <div class="official-info-label">اسم الزوج/ة:</div>
                            <div class="official-info-value" id="officialSpouseName"></div>
                        </div>
                        
                        <div class="official-info-row">
                            <div class="official-info-label">محل الولادة:</div>
                            <div class="official-info-value" id="officialBirthPlace"></div>
                        </div>
                        
                        <div class="official-info-row">
                            <div class="official-info-label">مكان السكن الحالي:</div>
                            <div class="official-info-value" id="officialResidence"></div>
                        </div>
                        
                        <div class="official-info-row">
                            <div class="official-info-label">رقم الهاتف:</div>
                            <div class="official-info-value" id="officialPhoneNumber"></div>
                        </div>
                        
                        <div class="official-info-row">
                            <div class="official-info-label">رقم الهوية:</div>
                            <div class="official-info-value" class="empty-field">.................</div>
                        </div>
                        
                        <div class="official-info-row">
                            <div class="official-info-label">تاريخ الإصدار:</div>
                            <div class="official-info-value" class="empty-field">.................</div>
                        </div>
                        
                        <div class="official-info-row">
                            <div class="official-info-label">رقم وصل القطع:</div>
                            <div class="official-info-value" class="empty-field">.................</div>
                        </div>
                        
                        <div class="official-info-row">
                            <div class="official-info-label">النقابة:</div>
                            <div class="official-info-value" id="officialUnion"></div>
                        </div>
                    </div>
                    
                    <div class="official-photo-container">
                        <div class="official-photo-placeholder" id="officialPhotoPlaceholder">
                            <i class="fas fa-user-circle"></i>
                            <div>الصورة الشخصية</div>
                        </div>
                        <img id="officialPhotoPreview" class="official-photo-preview" alt="الصورة الشخصية" style="display: none;">
                    </div>
                </div>
                
                <div class="declaration-section">
                    <div class="declaration-title">تعهد</div>
                    <div class="declaration-text">
                        أنا العامل/ <span id="declarationName"></span> اتعهد امامكم بأني امارس عملي في القطاع الخاص والمختلط والتعاوني واعمل بصفة عامل وغير موظف عمومي في القطاع العام او عقد وزاري او منتسب وزارة الداخلية او الدفاع كما اتعهد بصحة كافة الاوراق والمستمسكات المقدمة الى اتحادكم من قبلي وبخلاف ذلك اتحمل كافة التبعات القانونية وارغب بالانتماء الى نقابة (<span id="declarationUnion">.................................</span>) ومستعد لدفع بدل الاشتراك الشهري والسنوي 1% من الاجر الذي اتقاضاه وحسب ما نص عليه قانون التنظيم النقابي رقم 52 لسنة 1987.
                    </div>
                </div>
                
                <div class="signatures-section">
                    <div class="official-signature-box">
                        <div class="official-signature-line"></div>
                        <div class="official-signature-label">بصمة العامل</div>
                    </div>
                    
                    <div class="official-signature-box">
                        <div class="official-signature-line"></div>
                        <div class="official-signature-label">مصادقة النقابة المختصة</div>
                    </div>
                    
                    <div class="official-signature-box">
                        <div class="official-signature-line"></div>
                        <div class="official-signature-label">مصادقة الدائرة القانونية</div>
                    </div>
                </div>
                
                <div class="document-date">
                    صدرت هذه الوثيقة بتاريخ: <span id="officialDocumentDate"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== تهيئة المتغيرات ==========
        let supabaseClient = null;
        let applicationsData = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let currentApplicationId = null;
        let isProcessing = false;
        let currentApplicationData = null;
        let selectedUnion = '';
        let liveUpdateEnabled = true;
        let realtimeSubscription = null;
        let lastUpdateTimestamp = null;
        let newApplicationsIds = new Set(); // لتتبع الطلبات الجديدة غير المقروءة
        
        // ========== تهيئة Supabase ==========
        async function initializeSupabase() {
            try {
                const SUPABASE_URL = 'https://gjmrohuesytjtnlvgilo.supabase.co';
                const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdqbXJvaHVlc3l0anRubHZnaWxvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3MjMzOTEsImV4cCI6MjA4MTI5OTM5MX0.d-NOaVwweXllD0TokSUG5bGskHR9PYjsVSStfnxbjC8';
                
                console.log('🔄 جاري تهيئة لوحة التحكم مع التحديث المباشر...');
                
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // اختبار الاتصال
                const { data, error } = await supabaseClient
                    .from('membership_applications')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    console.error('❌ خطأ في الاتصال بقاعدة البيانات:', error.message);
                    showNotification('تعذر الاتصال بقاعدة البيانات. يرجى التحقق من الاتصال بالإنترنت.', 'error');
                    return false;
                } else {
                    console.log('✅ لوحة التحكم جاهزة للاستخدام!');
                    return true;
                }
                
            } catch (error) {
                console.error('❌ خطأ في التهيئة:', error);
                showNotification('تعذر الاتصال بقاعدة البيانات. يرجى التحقق من الاتصال بالإنترنت.', 'error');
                return false;
            }
        }
        
        // ========== تحميل البيانات مع التحديث المباشر ==========
        async function loadApplications(highlightNew = false) {
            if (isProcessing) return;
            
            try {
                isProcessing = true;
                if (!highlightNew) showLoading();
                
                console.log('📥 جاري تحميل البيانات من قاعدة البيانات...');
                
                const { data, error } = await supabaseClient
                    .from('membership_applications')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('❌ خطأ في تحميل البيانات:', error);
                    showNoDataMessage();
                    showNotification('حدث خطأ في تحميل البيانات', 'error');
                    return;
                }
                
                console.log(`✅ تم تحميل ${data?.length || 0} طلب`);
                
                const oldDataCount = applicationsData.length;
                applicationsData = data || [];
                const newDataCount = applicationsData.length;
                
                updateStats();
                renderApplicationsTable();
                setupPagination();
                updateLastUpdateTime();
                
                // إذا كانت هناك بيانات جديدة، عرض إشعار
                if (highlightNew && newDataCount > oldDataCount) {
                    const newItemsCount = newDataCount - oldDataCount;
                    showNotification(`تم إضافة ${newItemsCount} طلب جديد`, 'success');
                    
                    // إضافة الطلبات الجديدة إلى مجموعة غير المقروءة
                    const newItems = applicationsData.slice(0, newItemsCount);
                    newItems.forEach(item => {
                        newApplicationsIds.add(item.id);
                    });
                }
                
                if (applicationsData.length === 0) {
                    showNoDataMessage();
                } else {
                    hideNoDataMessage();
                }
                
            } catch (error) {
                console.error('❌ خطأ في تحميل البيانات:', error);
                showNoDataMessage();
                showNotification('حدث خطأ في تحميل البيانات', 'error');
            } finally {
                if (!highlightNew) hideLoading();
                isProcessing = false;
            }
        }
        
        // ========== تفعيل التحديث المباشر ==========
        async function setupRealtimeUpdates() {
            if (!supabaseClient || realtimeSubscription) return;
            
            try {
                console.log('🔔 جاري تفعيل التحديث المباشر...');
                
                realtimeSubscription = supabaseClient
                    .channel('membership_applications_changes')
                    .on(
                        'postgres_changes',
                        {
                            event: '*', // INSERT, UPDATE, DELETE
                            schema: 'public',
                            table: 'membership_applications'
                        },
                        async (payload) => {
                            console.log('📡 تحديث مباشر:', payload.eventType, payload.new);
                            
                            // عرض إشعار بالتحديث
                            const eventType = getEventTypeArabic(payload.eventType);
                            
                            if (payload.eventType === 'INSERT') {
                                showNotification(`${eventType} طلب جديد`, 'success');
                            } else {
                                showNotification(`${eventType} طلب`, 'info');
                            }
                            
                            // إعادة تحميل البيانات بعد تأخير بسيط
                            setTimeout(() => {
                                loadApplications(true);
                            }, 500);
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            console.log('✅ التحديث المباشر مفعل!');
                            document.getElementById('realtimeIndicator').classList.remove('off');
                        } else if (status === 'CHANNEL_ERROR') {
                            console.error('❌ خطأ في قناة التحديث المباشر');
                            document.getElementById('realtimeIndicator').classList.add('off');
                        }
                    });
                
            } catch (error) {
                console.error('❌ خطأ في تفعيل التحديث المباشر:', error);
                document.getElementById('realtimeIndicator').classList.add('off');
                showNotification('تعذر تفعيل التحديث المباشر', 'error');
            }
        }
        
        function getEventTypeArabic(eventType) {
            switch(eventType) {
                case 'INSERT': return 'تم إضافة';
                case 'UPDATE': return 'تم تحديث';
                case 'DELETE': return 'تم حذف';
                default: return 'تم تعديل';
            }
        }
        
        function toggleLiveUpdate() {
            liveUpdateEnabled = !liveUpdateEnabled;
            const toggleBtn = document.getElementById('liveUpdateToggle');
            const indicator = document.getElementById('realtimeIndicator');
            
            if (liveUpdateEnabled) {
                toggleBtn.innerHTML = '<i class="fas fa-broadcast-tower"></i> تحديث مباشر: مفعل';
                toggleBtn.classList.remove('disabled');
                indicator.classList.remove('off');
                setupRealtimeUpdates();
                showNotification('تم تفعيل التحديث المباشر', 'success');
            } else {
                toggleBtn.innerHTML = '<i class="fas fa-broadcast-tower"></i> تحديث مباشر: معطل';
                toggleBtn.classList.add('disabled');
                indicator.classList.add('off');
                
                if (realtimeSubscription) {
                    supabaseClient.removeChannel(realtimeSubscription);
                    realtimeSubscription = null;
                }
                
                showNotification('تم إيقاف التحديث المباشر', 'info');
            }
        }
        
        // ========== تحديث الإحصائيات مع الطابع الزمني ==========
        function updateStats() {
            const now = new Date();
            const today = new Date().toISOString().split('T')[0];
            
            const newCount = applicationsData.filter(app => app.application_type === 'new').length;
            const renewCount = applicationsData.filter(app => app.application_type === 'renew').length;
            const completedCount = applicationsData.filter(app => app.status === 'completed').length;
            const allCount = applicationsData.length;
            const todayCount = applicationsData.filter(app => {
                const appDate = new Date(app.created_at).toISOString().split('T')[0];
                return appDate === today;
            }).length;
            
            document.getElementById('newCount').textContent = newCount;
            document.getElementById('renewCount').textContent = renewCount;
            document.getElementById('completedCount').textContent = completedCount;
            document.getElementById('allCount').textContent = allCount;
            document.getElementById('todayCount').textContent = todayCount;
            document.getElementById('totalApplicationsCount').textContent = `(${allCount})`;
            
            // تحديث الطوابع الزمنية
            const timeString = now.toLocaleTimeString('ar-EG', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            document.getElementById('newUpdateTime').textContent = timeString;
            document.getElementById('renewUpdateTime').textContent = timeString;
            document.getElementById('completedUpdateTime').textContent = timeString;
            document.getElementById('allUpdateTime').textContent = timeString;
            document.getElementById('todayUpdateTime').textContent = timeString;
        }
        
        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ar-EG', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('lastUpdateTime').textContent = `آخر تحديث: ${timeString}`;
            lastUpdateTimestamp = now;
        }
        
        // ========== إدارة الصفحات (Pagination) ==========
        function setupPagination(filteredData = null) {
            const data = filteredData || applicationsData;
            const totalPages = Math.ceil(data.length / itemsPerPage);
            
            const paginationDiv = document.getElementById('pagination');
            paginationDiv.innerHTML = '';
            
            if (totalPages <= 1) {
                paginationDiv.style.display = 'none';
                return;
            }
            
            paginationDiv.style.display = 'flex';
            
            // زر الصفحة السابقة
            const prevBtn = document.createElement('button');
            prevBtn.className = 'page-btn';
            prevBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderApplicationsTable(filteredData);
                    setupPagination(filteredData);
                }
            };
            paginationDiv.appendChild(prevBtn);
            
            // أزرار الصفحات
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => {
                    currentPage = i;
                    renderApplicationsTable(filteredData);
                    setupPagination(filteredData);
                };
                paginationDiv.appendChild(pageBtn);
            }
            
            // زر الصفحة التالية
            const nextBtn = document.createElement('button');
            nextBtn.className = 'page-btn';
            nextBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderApplicationsTable(filteredData);
                    setupPagination(filteredData);
                }
            };
            paginationDiv.appendChild(nextBtn);
        }
        
        // ========== عرض البيانات في الجدول مع تسليط الضوء ==========
        function renderApplicationsTable(filteredData = null) {
            const dataToDisplay = filteredData || applicationsData;
            const tableBody = document.getElementById('applicationsTableBody');
            tableBody.innerHTML = '';
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, dataToDisplay.length);
            const pageData = dataToDisplay.slice(startIndex, endIndex);
            
            pageData.forEach((app, index) => {
                const row = document.createElement('tr');
                const globalIndex = startIndex + index + 1;
                
                // تنسيق التاريخ
                const date = new Date(app.created_at);
                const formattedDate = date.toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // تحديد حالة الطلب
                let statusBadge = '';
                let statusText = '';
                if (app.status === 'pending') {
                    statusBadge = 'status-pending';
                    statusText = 'قيد المعالجة';
                } else if (app.status === 'completed') {
                    statusBadge = 'status-completed';
                    statusText = 'مكتملة';
                }
                
                // تحديد نوع الطلب
                let typeBadge = '';
                let typeText = '';
                if (app.application_type === 'new') {
                    typeBadge = 'status-new';
                    typeText = 'جديدة';
                } else if (app.application_type === 'renew') {
                    typeBadge = 'status-renew';
                    typeText = 'تجديد';
                }
                
                // عرض النقابة - استخدام union_name أولاً، ثم union، ثم الافتراضي
                const unionText = app.union_name || app.union || 'لم يتم التحديد';
                
                // تحديد إذا كان الطلب جديد (غير مقروء)
                const isUnread = newApplicationsIds.has(app.id);
                
                // إضافة كلاس للصف الجديد غير المقروء
                if (isUnread) {
                    row.classList.add('new-row', 'unread');
                } else if (isApplicationNew(app.created_at)) {
                    row.classList.add('new-row');
                }
                
                row.innerHTML = `
                    <td>${globalIndex}</td>
                    <td><strong>${app.receipt_id || 'غير متوفر'}</strong></td>
                    <td>${app.full_name || 'غير متوفر'}</td>
                    <td>${app.phone_number || 'غير متوفر'}</td>
                    <td><span class="status-badge ${typeBadge}">${typeText}</span></td>
                    <td>${formattedDate}</td>
                    <td><span class="status-badge ${statusBadge}">${statusText}</span></td>
                    <td>${unionText}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-view" onclick="viewApplication('${app.id}')">
                                <i class="fas fa-eye"></i> عرض
                            </button>
                            <button class="btn btn-print" onclick="printReceiptFromTable('${app.id}')">
                                <i class="fas fa-print"></i> طباعة
                            </button>
                            <button class="btn btn-delete" onclick="deleteApplication('${app.id}')">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </td>
                `;
                
                // إضافة حدث للنقر على الصف لإزالة التمييز
                row.addEventListener('click', (e) => {
                    if (!e.target.closest('.action-buttons')) {
                        markAsRead(app.id);
                    }
                });
                
                tableBody.appendChild(row);
            });
        }
        
        function markAsRead(appId) {
            // إزالة الطلب من مجموعة غير المقروءة
            newApplicationsIds.delete(appId);
            
            // إعادة عرض الجدول لتحديث الأنماط
            renderApplicationsTable();
        }
        
        function isApplicationNew(createdAt) {
            if (!createdAt) return false;
            
            const createdTime = new Date(createdAt).getTime();
            const currentTime = new Date().getTime();
            const fiveMinutesAgo = currentTime - (5 * 60 * 1000);
            
            return createdTime > fiveMinutesAgo;
        }
        
        // ========== التصفية والبحث ==========
        function filterApplications() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filtered = applicationsData;
            
            // البحث
            if (searchTerm) {
                filtered = filtered.filter(app => 
                    (app.full_name && app.full_name.toLowerCase().includes(searchTerm)) ||
                    (app.phone_number && app.phone_number.includes(searchTerm)) ||
                    (app.receipt_id && app.receipt_id.toLowerCase().includes(searchTerm))
                );
            }
            
            // تصفية حسب النوع
            if (typeFilter !== 'all') {
                filtered = filtered.filter(app => app.application_type === typeFilter);
            }
            
            // تصفية حسب الحالة
            if (statusFilter !== 'all') {
                filtered = filtered.filter(app => app.status === statusFilter);
            }
            
            currentPage = 1;
            renderApplicationsTable(filtered);
            setupPagination(filtered);
        }
        
        // ========== عرض تفاصيل الطلب مع الصور - FIXED ==========
        async function viewApplication(id) {
            if (isProcessing) return;
            
            try {
                isProcessing = true;
                
                // استخدام select للحصول على جميع الحقول
                const { data, error } = await supabaseClient
                    .from('membership_applications')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) {
                    console.error('❌ خطأ في عرض الطلب:', error);
                    throw error;
                }
                
                console.log('📋 بيانات الطلب:', data);
                
                currentApplicationId = id;
                currentApplicationData = data;
                prepareView(data);
                
                // إزالة التمييز عند فتح الطلب
                markAsRead(id);
                
                showModal('viewModal');
                
            } catch (error) {
                console.error('❌ خطأ في عرض الطلب:', error);
                showNotification('حدث خطأ في عرض تفاصيل الطلب', 'error');
            } finally {
                isProcessing = false;
            }
        }
        
        function prepareView(data) {
            console.log('🖼️ تحضير عرض البيانات:', data);
            
            // تعبئة حقول العرض
            document.getElementById('viewReceiptId').textContent = data.receipt_id || 'غير متوفر';
            document.getElementById('viewFullName').textContent = data.full_name || 'غير متوفر';
            document.getElementById('viewPhoneNumber').textContent = data.phone_number || 'غير متوفر';
            document.getElementById('viewSpouseName').textContent = data.spouse_name || 'غير متوفر';
            document.getElementById('viewBirthPlace').textContent = data.birth_place || 'غير متوفر';
            document.getElementById('viewResidence').textContent = data.residence || 'غير متوفر';
            document.getElementById('viewApplicationType').textContent = 
                data.application_type === 'new' ? 'إصدار هوية لأول مرة' : 'تجديد الهوية';
            document.getElementById('viewReviewDate').textContent = data.review_date || 'غير متوفر';
            document.getElementById('viewIssueDate').textContent = data.issue_date || 'غير متوفر';
            document.getElementById('viewStatusText').textContent = 
                data.status === 'pending' ? 'قيد المعالجة' : 'مكتملة';
            
            // عرض النقابة - استخدام union_name أولاً، ثم union، ثم الافتراضي
            const unionValue = data.union_name || data.union || 'لم يتم التحديد';
            document.getElementById('viewUnion').textContent = unionValue;
            
            // تنسيق التواريخ
            const createdDate = new Date(data.created_at);
            document.getElementById('viewCreatedAt').textContent = createdDate.toLocaleDateString('ar-EG', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // عرض الصور - مع دعم صورة الهوية القديمة
            displayPhotos(data);
            
            // تعبئة حقول التعديل
            document.getElementById('viewStatus').value = data.status || 'pending';
            document.getElementById('viewUnionSelect').value = unionValue || '';
            
            // تعبئة عرض النقابة المختارة
            if (unionValue && unionValue !== 'لم يتم التحديد') {
                document.getElementById('selectedUnionName').textContent = unionValue;
                document.getElementById('selectedUnionDisplay').classList.add('visible');
            } else {
                document.getElementById('selectedUnionDisplay').classList.remove('visible');
            }
            
            // تحديث متغير النقابة المختارة
            selectedUnion = unionValue || '';
            
            // إزالة أي مستمعين سابقين لمنع التكرار
            const unionSelect = document.getElementById('viewUnionSelect');
            const newUnionSelect = unionSelect.cloneNode(true);
            unionSelect.parentNode.replaceChild(newUnionSelect, unionSelect);
            
            // إضافة حدث عند تغيير اختيار النقابة
            document.getElementById('viewUnionSelect').addEventListener('change', function() {
                selectedUnion = this.value;
                if (selectedUnion) {
                    document.getElementById('selectedUnionName').textContent = selectedUnion;
                    document.getElementById('selectedUnionDisplay').classList.add('visible');
                } else {
                    document.getElementById('selectedUnionDisplay').classList.remove('visible');
                }
            });
        }
        
        function displayPhotos(data) {
            console.log('🖼️ عرض الصور:', {
                has_personal_photo: data.has_personal_photo,
                personal_photo_base64: data.personal_photo_base64 ? 'موجود' : 'غير موجود',
                id_front_base64: data.id_front_base64 ? 'موجود' : 'غير موجود',
                id_back_base64: data.id_back_base64 ? 'موجود' : 'غير موجود',
                card_front_base64: data.card_front_base64 ? 'موجود' : 'غير موجود',
                card_back_base64: data.card_back_base64 ? 'موجود' : 'غير موجود',
                old_id_base64: data.old_id_base64 ? 'موجود' : 'غير موجود' // ✅ حقل الهوية القديمة
            });
            
            // الصورة الشخصية - دعم حقول متعددة
            let personalPhotoSrc = null;
            
            // البحث عن الصورة الشخصية في حقول مختلفة
            if (data.has_personal_photo && data.personal_photo_base64) {
                personalPhotoSrc = data.personal_photo_base64;
            } else if (data.personal_photo_url) {
                personalPhotoSrc = data.personal_photo_url;
            } else if (data.photo_url) {
                personalPhotoSrc = data.photo_url;
            }
            
            if (personalPhotoSrc) {
                document.getElementById('viewPersonalPhoto').src = personalPhotoSrc;
                document.getElementById('viewPersonalPhoto').style.display = 'block';
                document.getElementById('viewPhotoPlaceholder').style.display = 'none';
                console.log('✅ تم تحميل الصورة الشخصية');
            } else {
                document.getElementById('viewPersonalPhoto').style.display = 'none';
                document.getElementById('viewPhotoPlaceholder').style.display = 'flex';
                console.log('❌ لا توجد صورة شخصية');
            }
            
            // صورة الوجه الأمامي للهوية - البحث في حقول مختلفة
            let idFrontSrc = null;
            
            // أولوية: id_front_base64 (الكود القديم)
            if (data.id_front_base64) {
                idFrontSrc = data.id_front_base64;
                console.log('✅ وجدت id_front_base64');
            } 
            // ثانوية: card_front_base64 (الكود الجديد)
            else if (data.has_card_front && data.card_front_base64) {
                idFrontSrc = data.card_front_base64;
                console.log('✅ وجدت card_front_base64');
            }
            // ثالثة: card_front_url (URL)
            else if (data.card_front_url) {
                idFrontSrc = data.card_front_url;
                console.log('✅ وجدت card_front_url');
            }
            
            if (idFrontSrc) {
                document.getElementById('viewIdFront').src = idFrontSrc;
                document.getElementById('viewIdFront').style.display = 'block';
                document.getElementById('idFrontPlaceholder').style.display = 'none';
                console.log('✅ تم تحميل الوجه الأمامي للهوية');
            } else {
                document.getElementById('viewIdFront').style.display = 'none';
                document.getElementById('idFrontPlaceholder').style.display = 'block';
                console.log('❌ لا توجد صورة للوجه الأمامي للهوية');
            }
            
            // صورة الوجه الخلفي للهوية - البحث في حقول مختلفة
            let idBackSrc = null;
            
            // أولوية: id_back_base64 (الكود القديم)
            if (data.id_back_base64) {
                idBackSrc = data.id_back_base64;
                console.log('✅ وجدت id_back_base64');
            } 
            // ثانوية: card_back_base64 (الكود الجديد)
            else if (data.has_card_back && data.card_back_base64) {
                idBackSrc = data.card_back_base64;
                console.log('✅ وجدت card_back_base64');
            }
            // ثالثة: card_back_url (URL)
            else if (data.card_back_url) {
                idBackSrc = data.card_back_url;
                console.log('✅ وجدت card_back_url');
            }
            
            if (idBackSrc) {
                document.getElementById('viewIdBack').src = idBackSrc;
                document.getElementById('viewIdBack').style.display = 'block';
                document.getElementById('idBackPlaceholder').style.display = 'none';
                console.log('✅ تم تحميل الوجه الخلفي للهوية');
            } else {
                document.getElementById('viewIdBack').style.display = 'none';
                document.getElementById('idBackPlaceholder').style.display = 'block';
                console.log('❌ لا توجد صورة للوجه الخلفي للهوية');
            }
            
            // ✅ صورة الهوية القديمة - البحث في حقول مختلفة
            let oldIdSrc = null;
            
            // أولوية: old_id_base64 (الكود القديم)
            if (data.old_id_base64) {
                oldIdSrc = data.old_id_base64;
                console.log('✅ وجدت old_id_base64');
            }
            // ثانوية: old_id_url (URL)
            else if (data.old_id_url) {
                oldIdSrc = data.old_id_url;
                console.log('✅ وجدت old_id_url');
            }
            // ثالثة: old_card_base64 (أسماء بديلة)
            else if (data.old_card_base64) {
                oldIdSrc = data.old_card_base64;
                console.log('✅ وجدت old_card_base64');
            }
            
            if (oldIdSrc) {
                document.getElementById('viewOldId').src = oldIdSrc;
                document.getElementById('viewOldId').style.display = 'block';
                document.getElementById('oldIdPlaceholder').style.display = 'none';
                console.log('✅ تم تحميل صورة الهوية القديمة');
            } else {
                document.getElementById('viewOldId').style.display = 'none';
                document.getElementById('oldIdPlaceholder').style.display = 'block';
                console.log('❌ لا توجد صورة للهوية القديمة');
            }
        }
        
        // ========== عرض الصورة بشكل كامل مع دعم الهوية القديمة ==========
        function showFullImage(imageType) {
            let imageSrc = '';
            let imageTitle = '';
            
            switch(imageType) {
                case 'personalPhoto':
                    const personalPhoto = document.getElementById('viewPersonalPhoto');
                    if (personalPhoto.style.display === 'none') return;
                    imageSrc = personalPhoto.src;
                    imageTitle = 'الصورة الشخصية';
                    break;
                    
                case 'idFront':
                    const idFront = document.getElementById('viewIdFront');
                    if (idFront.style.display === 'none') return;
                    imageSrc = idFront.src;
                    imageTitle = 'الوجه الأمامي للهوية';
                    break;
                    
                case 'idBack':
                    const idBack = document.getElementById('viewIdBack');
                    if (idBack.style.display === 'none') return;
                    imageSrc = idBack.src;
                    imageTitle = 'الوجه الخلفي للهوية';
                    break;
                    
                case 'oldId':
                    const oldId = document.getElementById('viewOldId');
                    if (oldId.style.display === 'none') return;
                    imageSrc = oldId.src;
                    imageTitle = 'الهوية القديمة';
                    break;
                    
                default:
                    return;
            }
            
            if (!imageSrc) return;
            
            document.getElementById('fullImageView').src = imageSrc;
            document.getElementById('imageViewerTitle').textContent = imageTitle;
            document.getElementById('imageViewerModal').style.display = 'block';
            document.getElementById('modalOverlay').style.display = 'block';
            
            setTimeout(() => {
                document.getElementById('imageViewerModal').style.opacity = '1';
                document.getElementById('modalOverlay').style.opacity = '1';
            }, 10);
        }
        
        function closeImageViewer() {
            document.getElementById('imageViewerModal').style.opacity = '0';
            document.getElementById('modalOverlay').style.opacity = '0';
            
            setTimeout(() => {
                document.getElementById('imageViewerModal').style.display = 'none';
                document.getElementById('modalOverlay').style.display = 'none';
            }, 200);
        }
        
        // ========== تحرير الحقول مباشرة ==========
        function editField(fieldName, element) {
            const currentValue = element.textContent;
            
            // إنشاء حقل الإدخال
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'edit-input';
            input.value = currentValue;
            input.id = `edit_${fieldName}`;
            
            // إنشاء أزرار الحفظ والإلغاء
            const editButtons = document.createElement('div');
            editButtons.className = 'edit-buttons';
            editButtons.innerHTML = `
                <button class="edit-btn save" onclick="saveFieldEdit('${fieldName}')">
                    <i class="fas fa-check"></i> حفظ
                </button>
                <button class="edit-btn cancel" onclick="cancelFieldEdit('${fieldName}', '${currentValue}')">
                    <i class="fas fa-times"></i> إلغاء
                </button>
            `;
            
            // استبدال العنصر
            element.innerHTML = '';
            element.appendChild(input);
            element.appendChild(editButtons);
            input.focus();
        }
        
        async function saveFieldEdit(fieldName) {
            const input = document.getElementById(`edit_${fieldName}`);
            const newValue = input.value.trim();
            
            if (!newValue) {
                showNotification('لا يمكن ترك الحقل فارغاً', 'error');
                return;
            }
            
            try {
                // تحديث قاعدة البيانات
                const updateData = { [fieldName]: newValue };
                const { error } = await supabaseClient
                    .from('membership_applications')
                    .update(updateData)
                    .eq('id', currentApplicationId);
                
                if (error) throw error;
                
                // تحديث العرض
                const element = document.querySelector(`#view${fieldName.charAt(0).toUpperCase() + fieldName.slice(1)}`);
                if (element) {
                    element.textContent = newValue;
                    element.classList.add('editable');
                    element.setAttribute('onclick', `editField('${fieldName}', this)`);
                }
                
                showNotification('تم حفظ التغيير بنجاح', 'success');
                
            } catch (error) {
                console.error('❌ خطأ في حفظ التعديل:', error);
                showNotification('حدث خطأ في حفظ التغيير', 'error');
            }
        }
        
        function cancelFieldEdit(fieldName, oldValue) {
            const element = document.querySelector(`#view${fieldName.charAt(0).toUpperCase() + fieldName.slice(1)}`);
            if (element) {
                element.innerHTML = oldValue;
                element.classList.add('editable');
                element.setAttribute('onclick', `editField('${fieldName}', this)`);
            }
        }
        
        // ========== ✅ دالة طباعة الوصل الرسمي ==========
        function printOfficialReceipt() {
            if (!currentApplicationData) return;
            
            const data = currentApplicationData;
            
            // تحديث المعلومات في وصل الانتساب الرسمي
            document.getElementById('officialFullName').textContent = data.full_name || 'غير متوفر';
            document.getElementById('officialSpouseName').textContent = data.spouse_name || 'غير متوفر';
            document.getElementById('officialBirthPlace').textContent = data.birth_place || 'غير متوفر';
            document.getElementById('officialResidence').textContent = data.residence || 'غير متوفر';
            document.getElementById('officialPhoneNumber').textContent = data.phone_number || 'غير متوفر';
            document.getElementById('declarationName').textContent = data.full_name || 'المتقدم';
            
            // إضافة اسم النقابة المختارة
            const unionToDisplay = selectedUnion || data.union_name || data.union || 'لم يتم التحديد';
            document.getElementById('officialUnion').textContent = unionToDisplay;
            
            // تحديث التعهد ليشمل اسم النقابة
            document.getElementById('declarationUnion').textContent = unionToDisplay;
            
            // تاريخ اليوم
            const today = new Date();
            const todayFormatted = today.toLocaleDateString('ar-EG', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('officialDocumentDate').textContent = todayFormatted;
            
            // عرض الصورة الشخصية
            let personalPhotoSrc = null;
            if (data.has_personal_photo && data.personal_photo_base64) {
                personalPhotoSrc = data.personal_photo_base64;
            } else if (data.personal_photo_url) {
                personalPhotoSrc = data.personal_photo_url;
            } else if (data.photo_url) {
                personalPhotoSrc = data.photo_url;
            }
            
            if (personalPhotoSrc) {
                document.getElementById('officialPhotoPreview').src = personalPhotoSrc;
                document.getElementById('officialPhotoPreview').style.display = 'block';
                document.getElementById('officialPhotoPlaceholder').style.display = 'none';
            } else {
                document.getElementById('officialPhotoPreview').style.display = 'none';
                document.getElementById('officialPhotoPlaceholder').style.display = 'flex';
            }
            
            // إظهار الوصل الرسمي
            document.getElementById('officialReceipt').classList.add('visible');
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('modalOverlay').style.opacity = '1';
            
            // إضافة مؤشر تحميل
            const printBtn = document.getElementById('printOfficialReceiptBtn');
            const originalText = printBtn.innerHTML;
            printBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحميل...';
            printBtn.disabled = true;
            
            // الانتظار قليلاً ثم التقاط الصورة
            setTimeout(() => {
                captureReceiptAsImage('officialReceipt', `وصل_انتساب_رسمي_${data.receipt_id || data.id}.png`);
            }, 500);
        }
        
        // ========== ✅ دالة طباعة الوصل من الجدول ==========
        async function printReceiptFromTable(id) {
            if (isProcessing) return;
            
            try {
                isProcessing = true;
                
                // البحث عن البيانات في الذاكرة أولاً
                let data = applicationsData.find(app => app.id === id);
                
                // إذا لم توجد في الذاكرة، جلبها من قاعدة البيانات
                if (!data) {
                    const result = await supabaseClient
                        .from('membership_applications')
                        .select('*')
                        .eq('id', id)
                        .single();
                    
                    if (result.error) throw result.error;
                    data = result.data;
                }
                
                // حفظ البيانات للاستخدام
                currentApplicationData = data;
                currentApplicationId = id;
                
                // طباعة الوصل الرسمي
                printOfficialReceipt();
                
            } catch (error) {
                console.error('❌ خطأ في طباعة الوصل:', error);
                showNotification('حدث خطأ في طباعة الوصل', 'error');
            } finally {
                isProcessing = false;
            }
        }
        
        // ========== ✅ دالة التقاط الوصل كصورة وتحميلها تلقائياً ==========
        function captureReceiptAsImage(elementId, fileName) {
            const receiptElement = document.getElementById(elementId);
            const isOfficial = elementId === 'officialReceipt';
            
            const options = {
                scale: isOfficial ? 1.2 : 1.5,
                backgroundColor: '#ffffff',
                useCORS: true,
                logging: false,
                allowTaint: true,
                scrollX: 0,
                scrollY: 0,
                width: receiptElement.offsetWidth,
                height: receiptElement.offsetHeight,
                x: 0,
                y: 0,
                imageTimeout: 15000,
                onclone: function(clonedDoc) {
                    const clonedElement = clonedDoc.getElementById(elementId);
                    
                    if (isOfficial) {
                        clonedElement.style.width = '800px';
                        clonedElement.style.height = 'auto';
                        clonedElement.style.position = 'absolute';
                        clonedElement.style.left = '0';
                        clonedElement.style.top = '0';
                        clonedElement.style.transform = 'none';
                        
                        const allTextElements = clonedElement.querySelectorAll('*');
                        allTextElements.forEach(el => {
                            if (el.tagName !== 'IMG') {
                                el.style.color = '#000000';
                                el.style.fontWeight = 'bold';
                                el.style.textShadow = 'none';
                                el.style.fontSize = '14px';
                            }
                        });
                        
                        const titles = clonedElement.querySelectorAll('h1, h2, h3');
                        titles.forEach(title => {
                            title.style.fontSize = title.style.fontSize || '20px';
                            title.style.color = '#000000';
                            title.style.fontWeight = '900';
                        });
                    } else {
                        clonedElement.style.transform = 'none';
                        clonedElement.style.position = 'absolute';
                        clonedElement.style.left = '0';
                        clonedElement.style.top = '0';
                    }
                }
            };
            
            html2canvas(receiptElement, options).then(canvas => {
                const ctx = canvas.getContext('2d');
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                
                const highQualityCanvas = document.createElement('canvas');
                highQualityCanvas.width = canvas.width;
                highQualityCanvas.height = canvas.height;
                const hqCtx = highQualityCanvas.getContext('2d');
                
                hqCtx.fillStyle = '#ffffff';
                hqCtx.fillRect(0, 0, highQualityCanvas.width, highQualityCanvas.height);
                
                hqCtx.drawImage(canvas, 0, 0);
                
                const link = document.createElement('a');
                link.download = fileName;
                link.href = highQualityCanvas.toDataURL('image/png', 1.0);
                
                // إغلاق الوصل بعد التنزيل
                document.getElementById('officialReceipt').classList.remove('visible');
                document.getElementById('modalOverlay').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('modalOverlay').style.display = 'none';
                }, 300);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // إعادة تعيين زر الطباعة
                const printBtn = document.getElementById('printOfficialReceiptBtn');
                if (printBtn) {
                    printBtn.innerHTML = '<i class="fas fa-file-contract"></i> طباعة الوصل الرسمي';
                    printBtn.disabled = false;
                }
                
                setTimeout(() => {
                    showNotification(`تم تنزيل ${fileName} بنجاح!`, 'success');
                }, 500);
                
            }).catch(error => {
                console.error('خطأ في إنشاء الصورة:', error);
                
                try {
                    html2canvas(receiptElement, {
                        scale: 1,
                        backgroundColor: '#ffffff',
                        useCORS: true
                    }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = fileName;
                        link.href = canvas.toDataURL('image/png');
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        // إعادة تعيين زر الطباعة
                        const printBtn = document.getElementById('printOfficialReceiptBtn');
                        if (printBtn) {
                            printBtn.innerHTML = '<i class="fas fa-file-contract"></i> طباعة الوصل الرسمي';
                            printBtn.disabled = false;
                        }
                        
                        document.getElementById('officialReceipt').classList.remove('visible');
                        document.getElementById('modalOverlay').style.opacity = '0';
                        setTimeout(() => {
                            document.getElementById('modalOverlay').style.display = 'none';
                        }, 300);
                        
                        showNotification(`تم تنزيل ${fileName} بنجاح! (بجودة منخفضة)`, 'info');
                    });
                } catch (secondError) {
                    // إعادة تعيين زر الطباعة
                    const printBtn = document.getElementById('printOfficialReceiptBtn');
                    if (printBtn) {
                        printBtn.innerHTML = '<i class="fas fa-file-contract"></i> طباعة الوصل الرسمي';
                        printBtn.disabled = false;
                    }
                    
                    document.getElementById('officialReceipt').classList.remove('visible');
                    document.getElementById('modalOverlay').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('modalOverlay').style.display = 'none';
                    }, 300);
                    
                    showNotification('حدث خطأ أثناء إنشاء الوصل. يرجى المحاولة مرة أخرى.', 'error');
                }
            });
        }
        
        // ========== ✅ طباعة الوصل من نافذة العرض ==========
        function printOfficialReceiptFromViewModal() {
            if (!currentApplicationData) return;
            
            printOfficialReceipt();
        }
        
        // ========== حفظ جميع التغييرات ==========
        async function saveChanges() {
            if (!currentApplicationId || isProcessing) return;
            
            try {
                isProcessing = true;
                
                // التحقق من أن النقابة ليست فارغة
                if (!selectedUnion) {
                    selectedUnion = document.getElementById('viewUnionSelect').value;
                }
                
                const updatedData = {
                    status: document.getElementById('viewStatus').value,
                    updated_at: new Date().toISOString()
                };
                
                // إضافة النقابة إذا كانت موجودة
                if (selectedUnion && selectedUnion !== 'لم يتم التحديد') {
                    updatedData.union = selectedUnion;
                    updatedData.union_name = selectedUnion;
                }
                
                console.log('📝 بيانات التحديث:', updatedData);
                
                const { data, error } = await supabaseClient
                    .from('membership_applications')
                    .update(updatedData)
                    .eq('id', currentApplicationId)
                    .select();
                
                if (error) {
                    console.error('❌ خطأ في حفظ التغييرات:', error);
                    
                    // محاولة باستخدام union فقط
                    if (updatedData.union_name) {
                        delete updatedData.union_name;
                        const { data: retryData, error: retryError } = await supabaseClient
                            .from('membership_applications')
                            .update(updatedData)
                            .eq('id', currentApplicationId)
                            .select();
                        
                        if (retryError) throw retryError;
                    } else {
                        throw error;
                    }
                }
                
                showNotification('تم حفظ جميع التغييرات بنجاح!', 'success');
                closeModal('viewModal');
                loadApplications(true);
                
            } catch (error) {
                console.error('❌ خطأ في حفظ التغييرات:', error);
                showNotification('حدث خطأ في حفظ التغييرات', 'error');
            } finally {
                isProcessing = false;
            }
        }
        
        // ========== حذف الطلب ==========
        async function deleteApplication(id) {
            if (isProcessing) return;
            
            if (!confirm('هل أنت متأكد من حذف هذا الطلب؟ هذا الإجراء لا يمكن التراجع عنه.')) {
                return;
            }
            
            try {
                isProcessing = true;
                const { error } = await supabaseClient
                    .from('membership_applications')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                // إزالة من مجموعة غير المقروءة
                newApplicationsIds.delete(id);
                
                showNotification('تم حذف الطلب بنجاح!', 'success');
                loadApplications(true);
                
            } catch (error) {
                console.error('❌ خطأ في حذف الطلب:', error);
                showNotification('حدث خطأ في حذف الطلب', 'error');
            } finally {
                isProcessing = false;
            }
        }
        
        // ========== دوال مساعدة ==========
        function showLoading() {
            document.getElementById('tableLoading').style.display = 'block';
            document.getElementById('applicationsTable').style.opacity = '0.5';
        }
        
        function hideLoading() {
            document.getElementById('tableLoading').style.display = 'none';
            document.getElementById('applicationsTable').style.opacity = '1';
        }
        
        function showNoDataMessage() {
            document.getElementById('noDataMessage').style.display = 'block';
            document.getElementById('applicationsTable').style.display = 'none';
            document.getElementById('pagination').style.display = 'none';
        }
        
        function hideNoDataMessage() {
            document.getElementById('noDataMessage').style.display = 'none';
            document.getElementById('applicationsTable').style.display = 'table';
        }
        
        function showModal(modalId) {
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById(modalId).style.display = 'block';
            
            setTimeout(() => {
                document.getElementById('modalOverlay').style.opacity = '1';
                document.getElementById(modalId).style.opacity = '1';
            }, 10);
            
            document.body.style.overflow = 'hidden';
        }
        
        function closeModal(modalId) {
            document.getElementById('modalOverlay').style.opacity = '0';
            document.getElementById(modalId).style.opacity = '0';
            
            setTimeout(() => {
                document.getElementById('modalOverlay').style.display = 'none';
                document.getElementById(modalId).style.display = 'none';
                document.body.style.overflow = 'auto';
                currentApplicationId = null;
                currentApplicationData = null;
                selectedUnion = '';
            }, 200);
        }
        
        function showNotification(message, type = 'info') {
            // إزالة أي إشعارات سابقة
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(-50%) translateY(-100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // ========== تهيئة الصفحة ==========
        async function initializePage() {
            console.log('🚀 بدء تهيئة لوحة التحكم...');
            
            try {
                const initialized = await initializeSupabase();
                
                if (initialized) {
                    await loadApplications();
                    
                    // تفعيل التحديث المباشر
                    setupRealtimeUpdates();
                    
                    // إعداد أزرار التصفية والبحث
                    document.getElementById('searchInput').addEventListener('input', filterApplications);
                    document.getElementById('typeFilter').addEventListener('change', filterApplications);
                    document.getElementById('statusFilter').addEventListener('change', filterApplications);
                    
                    document.getElementById('refreshBtn').addEventListener('click', async () => {
                        document.getElementById('refreshBtn').disabled = true;
                        await loadApplications();
                        document.getElementById('refreshBtn').disabled = false;
                        showNotification('تم تحديث البيانات بنجاح', 'success');
                    });
                    
                    document.getElementById('liveUpdateToggle').addEventListener('click', toggleLiveUpdate);
                    
                    // إعداد أزرار المودال
                    document.getElementById('closeViewModal').addEventListener('click', () => closeModal('viewModal'));
                    document.getElementById('closeViewBtn').addEventListener('click', () => closeModal('viewModal'));
                    document.getElementById('saveChangesBtn').addEventListener('click', saveChanges);
                    document.getElementById('closeImageViewer').addEventListener('click', closeImageViewer);
                    
                    // إغلاق المودال عند النقر على الخلفية
                    document.getElementById('modalOverlay').addEventListener('click', function() {
                        closeModal('viewModal');
                        closeImageViewer();
                        document.getElementById('officialReceipt').classList.remove('visible');
                        this.style.opacity = '0';
                        setTimeout(() => {
                            this.style.display = 'none';
                        }, 300);
                    });
                    
                    // إغلاق المودال عند الضغط على ESC
                    document.addEventListener('keydown', function(event) {
                        if (event.key === 'Escape') {
                            closeModal('viewModal');
                            closeImageViewer();
                            document.getElementById('officialReceipt').classList.remove('visible');
                            document.getElementById('modalOverlay').style.opacity = '0';
                            setTimeout(() => {
                                document.getElementById('modalOverlay').style.display = 'none';
                            }, 300);
                        }
                    });
                    
                    console.log('✅ لوحة التحكم مع التحديث المباشر جاهزة!');
                    showNotification('لوحة التحكم جاهزة للاستخدام', 'success');
                    
                } else {
                    showNotification('تعذر الاتصال بقاعدة البيانات. يرجى التحقق من الاتصال بالإنترنت.', 'error');
                }
            } catch (error) {
                console.error('❌ خطأ في تهيئة الصفحة:', error);
                showNotification('حدث خطأ في تهيئة لوحة التحكم', 'error');
            }
        }
        
        // تشغيل التهيئة عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
